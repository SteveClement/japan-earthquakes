<!DOCTYPE html>
<html>
<body>
  <div id='viz'></div>
  #### Time lapse visualization of all earthquakes of magnitude > 5 in Japan in 2011.

  Each circle represents a single earthquake of magnitude 5 or more: the larger the radius, the larger the magnitude.

  Note the Tohoku earthquake (the largest recorded earthquake in Japan's history) on March 11 2011. As can be seen on the map, the aftershakes from this quake continue for months afterwards.

  Japan Earthquake Data: [USGS](http://earthquake.usgs.gov/earthquakes/search/)

  Japan Map Topojson Data: [Data of Japan](https://github.com/dataofjapan/land)

  <script src="//d3js.org/d3.v3.min.js"></script>
  <script src="https://d3js.org/topojson.v0.min.js"></script>
  <script>
  var width = 960,
      height = 500;

  var svg = d3.select("viz")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

  var color_scale = d3.scale.linear()
      .domain([5, 6.5, 9])
      .range(["green", "yellow", "red"]);

  var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

  svg.selectAll("text")
      .data(months)
      .enter()
      .append("text")
      .attr("x", function(d,i) { return width * (i + 0.5) / 12;})
      .attr("y", height - 20)
      .text(function(d) { return d;})
      .attr("text-anchor", "middle")
      .attr("font-family", "Helvetica Neue")
      .attr("font-size", 15)
      .attr("font-weight", 200);

  var time_format = d3.time.format("%Y-%m-%d-%H-%M"); // Date is stored as year/month/day/hour/minute
  var start_time = +(new Date(2011, 0, 1, 0, 1)); // Start time on Jan 1st 2011 at 00:01
  var end_time = +(new Date(2012, 0, 1, 0, 1)); // End Jan 1st 2012 at 00:01
  var time_speed_up = 900000;

  // Returns a date object from time string of dataset
  function parse_time_string(time_string) {
      var year_month_day = time_string.slice(0, 10);
      var hour = time_string.slice(11,13);
      var minute = time_string.slice(14,16);
      return time_format.parse(year_month_day + "-" + hour + "-" + minute);
  }

  var projection = d3.geo.mercator()
              .center([139, 34.5])
              .scale(970)
              .translate([width / 2, height / 2]);

  d3.json("japan.geojson", function (error, japan) {
      /* Create Map */
      var path = d3.geo.path()
              .projection(projection);

      svg.selectAll("path")
          .data(japan.features)
          .enter()
          .append("path")
          .attr("fill", "#9ecae1")
          .attr("stroke", "#3182bd")
          .attr("stroke-width", ".5")
          .attr("d", path);

      /* Add earthquakes */
      d3.csv("japan_2011_mag_5.csv", function(d) {
          return {
              mag: +d.mag,
              latitude: +d.latitude,
              longitude: +d.longitude,
              date : parse_time_string(d.time)
              };
          }, function(error, earthquakes) {
              svg.selectAll("circle")
                  .data(earthquakes)
                  .enter()
                  .append("circle")
                  .attr("cx", function(d) { return projection([d.longitude, d.latitude])[0] })
                  .attr("cy", function(d) { return projection([d.longitude, d.latitude])[1] })
                  .attr("r", 0)
                  .attr("fill", "none")
                  .attr("stroke", function(d) { return color_scale(d.mag); })
                  .attr("stroke-width", function(d) { return d.mag / 2; })
                  .attr("opacity", 1)
                  .transition()
                  .duration(function(d) { return Math.pow( 1.3, d.mag ) * 300 })
                  .delay(function(d) {
                      return (+d.date - start_time) / time_speed_up; })
                  .ease("linear")
                  .attr("r", function(d) { return Math.pow( 1.5, d.mag ) * 2; })
                  .attr("opacity", 0)
                  .remove();

              /* Slider which keeps track of the date */
              svg.append("rect")
                 .attr("x", 0)
                 .attr("y", height - 11)
                 .attr("height", 10)
                 .attr("width", 10)
                 .attr("fill", "none")
                 .attr("stroke-width", 1)
                 .attr("stroke", "black")
                 .transition()
                 .duration((end_time - start_time) / time_speed_up)
                 .ease("linear")
                 .attr("x", width - 11);
      });
  });

  </script>

</body>
</html>